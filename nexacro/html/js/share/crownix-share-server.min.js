exports.createReport=function(b,c,a){return new Report(b,c,a)};var Report=function(e,i,l){var a=e.name,k=e.password,g=e.mrd,h=e.curPage,c={},b=[],i=i,j=true,f=0,o="wait",n=e.options||{};function d(q){if(q==null){return true}if(q.length>0){return false}if(q.length===0){return true}if(typeof q!=="object"){return true}for(var p in q){if(hasOwnProperty.call(q,p)){return false}}return true}this.reopenReport=function(p){g=p.mrd,h=p.curPage,b=[],f=0,o="wait",n=p.options||{}};this.focusOnField=function(p,q){c[q]={formId:p.formId,fieldId:p.fieldId}};this.focusOutField=function(q){if(c[q]){var p={formId:c[q].formId,fieldId:c[q].fieldId};c[q]=undefined;return p}};var m=function(q){if(typeof q!=="string"||q.length==0){return}var p=q.substr(q.indexOf('path="')+6);return p.substr(0,p.indexOf('"'))};this.changeLock=function(p){j=p};this.changeLock=function(p){j=p};this.isLock=function(){return j};this.getName=function(){return a};this.getPassword=function(){return k};this.getMrd=function(){return g};this.getCurPage=function(){return h};this.setHostId=function(p){i=p};this.getHostId=function(){return i};this.syncDone=function(){++f};this.incSyncCnt=function(p){if(p){f+=p}else{++f}};this.decSyncCnt=function(){if(f>0){--f}};this.initSyncDoneCount=function(){f=0};this.getSyncDoneCount=function(){return f};this.setSyncState=function(p){o=p};this.getSyncState=function(){return o};this.setHostPage=function(p){h=p};this.getFocusInfo=function(r){if(r){var q={};for(var p in c){if(r!=c){q[p]=c[p]}}return q}return c};this.getOption=function(p){return n[p]};this.setOption=function(p,q){n[p]=q}};exports.createReportManager=function(b,a){return new ReportManager(b,a)};var ReportManager=function(c,a){var b=[];this.createReport=function(e,f){if(!this.getReport(e.name)){var d=exports.createReport(e,f,c);b.push(d);return d}};this.joinReport=function(e){var d=this.getReport(e.name);if(d){if(d.getPassword()&&d.getPassword()!=e.password){return"share_wrong_password"}return d}else{return"share_undefined_room"}};this.getReport=function(e){var d;b.some(function(f){if(e==f.getName()){d=f;return true}});return d};this.getReports=function(){return b};this.getReportList=function(){var d=b.sort(function(g,f){if(g.getName()<f.getName()){return -1}if(g.getName()>f.getName()){return 1}return 0});var e=[];d.forEach(function(f){e.push({name:f.getName(),isPublic:!f.getPassword(),userCount:a.getUserCount(f.getName())})});return e};this.removeReport=function(d){b.some(function(e){if(e.getName()===d){b.splice(b.indexOf(e),1);return true}})}};exports.start=function(){process.on("uncaughtException",function(t){if(s){s.log("crit","[uncaughtException] "+t.stack)}else{console.log("[uncaughtException] "+t.stack)}});var c=require("fs");var r=require("v8");var e=require("os");var d=require("https");var f=require("socket.io");var m=exports.ConfigManager||require("./crownix-share-configManager.js").ConfigManager;var q=new m();var p=c.readdirSync("./").indexOf("crownix-share-logger.js")>=0?require("./crownix-share-logger.js"):require("./crownix-share-logger.min.js");var s=new p(q.getConfig("server.log"));var h=q.getConfig("server.port");var i=q.getConfig("server.ssl");var k={pingInterval:q.getConfig("server.opts.pingInterval"),pingTimeout:q.getConfig("server.opts.pingTimeout")};if(i!==undefined){var g={};if(i.key){g.key=c.readFileSync(i.key).toString()}if(i.cert){g.cert=c.readFileSync(i.cert).toString()}if(i.pfx){g.pfx=c.readFileSync(i.pfx).toString()}if(i.passphrase){g.passphrase=i.passphrase}var n=d.createServer(g,function(u,t){t.writeHead(200);t.end()});f=f(n,k);n.listen(h);console.log("Server Running at https://ServerURL:"+h)}else{f=f.listen(h,k);console.log("Server Running at http://ServerURL:"+h)}var j=Object.prototype.hasOwnProperty;s.log("info","[Server start] module load complete. Share Server start. \r\n Node.js Version:"+process.version+" \r\n OS type: "+e.type());var b=function(){this.getHeapUsage=function(){var t=r.getHeapStatistics();return((t.used_heap_size/t.total_heap_size)*100).toFixed(2)};this.getHeapProportion=function(){var t=r.getHeapStatistics();return((t.total_heap_size/t.heap_size_limit)*100).toFixed(2)}};var a={getUserCount:function(t){var u=f.sockets.adapter.rooms[t];return u?u.length:0}};var l=new b();var o=exports.createReportManager(s,a);f.sockets.on("connection",function(v){s.log("debug","[client connect] new client "+v.id+" connect.");var u,x="waiting";function t(z){v.leave(x);v.join(z);x=z}function y(){v.leave(x);v.join("waiting");x="waiting"}function w(z,A){return{mrd:z.getMrd(),pageNo:z.getCurPage(),formData:A.formData,focusInfo:z.getFocusInfo(v.id),noteData:A.noteData&&JSON.parse(A.noteData),isLock:z.isLock()}}v.join(x);v.emit("reportList",o.getReportList());v.on("createReport",function(B,z){var A=o.createReport(B,v.id);if(A){u=A;t(B.name);v.emit("startSharing","host");z({name:B.name,password:B.password});f.to("waiting").emit("newReport",{name:B.name,isPublic:!B.password});if(l.getHeapProportion()>95){s.log("warning","heap memory proportion: "+l.getHeapProportion()+"%. becoming closer to the heap size limit.")}s.log("info","[create report] report created. \r\n name: "+B.name+" \r\n host: "+v.id+" \r\n type: "+(B.password?"private":"public"))}else{v.emit("shareError",{message:"share_duplicated_name"})}});v.on("reopenReport",function(z){u.reopenReport(z);f.sockets.sockets[u.getHostId()].emit("getFormData",undefined,function(A){v.broadcast.to(x).emit("openFile",w(u,A))});s.log("info","[reopen report] report reopened. \r\n report: "+u.getName()+" \r\n opener: "+v.id)});v.on("joinReport",function(B,z){var A=o.joinReport(B);if(A&&typeof A==="object"){u=A;if(!B.reconnect){f.to("waiting").emit("renewUserCount",{name:B.name,incCount:true})}f.sockets.sockets[u.getHostId()].emit("getFormData",undefined,function(C){v.emit("openFile",w(u,C));t(B.name);var D=B.isHost;if(D){u.setHostId(v.id)}v.emit("startSharing",D?"host":"client");z({name:B.name,password:B.password});s.log("info","[join report] client "+v.id+" join report: "+B.name)})}else{if(A&&typeof A==="string"){v.emit("shareError",{message:A})}}});v.on("formField",function(z){if(u){v.broadcast.to(x).emit("formField",z)}});v.on("focusOn",function(A){if(u){var z=u.focusOutField(v.id);if(z){v.broadcast.to(x).emit("focusOut",z)}u.focusOnField(A,v.id);A.isLock=u.isLock();v.broadcast.to(x).emit("focusOn",A)}});v.on("focusOut",function(){if(u){var z=u.focusOutField(v.id);if(z){v.broadcast.to(x).emit("focusOut",z)}}});v.on("lockFields",function(){if(!u.isLock()){u.changeLock(true);v.broadcast.to(x).emit("lockFields");v.broadcast.to(x).emit("movePage",u.getCurPage())}});v.on("unlockFields",function(){if(u.isLock()){u.changeLock(false);v.broadcast.to(x).emit("unlockFields")}});v.on("submitRequest",function(D,A){s.log("info","[submit request] client "+v.id+" request for submit. \r\n report: "+u.getName());var C=u.getSyncState();if(C==="synchronization"||C==="done"){return}u.setSyncState("synchronization");var z=Object.keys(f.sockets.adapter.rooms[x].sockets);if(z.length===1||v.id==u.getHostId()){A("done");u.setSyncState("done");return}for(var B=0;B<z.length;B++){(function(){var E=B;f.sockets.connected[z[E]].once("syncDone",function(){u.syncDone();s.log("debug","[sync done] sync done event emitted from client "+f.sockets.connected[z[E]].id);if(u.getSyncDoneCount()===(a.getUserCount(x)-1)){A("done");u.setSyncState("done");s.log("debug","[all client sync done] all client sync done event emitted in report "+x)}})})()}f.sockets.sockets[u.getHostId()].emit("getFormData",undefined,function(E){v.broadcast.to(x).emit("syncFormData",E.formData)});s.log("debug","[sync form data] form data broadcast for field synchronization. in report "+x)});v.on("submitFinished",function(z){s.log("info","[submit finished] submit finished. \r\n report: "+u.getName());v.broadcast.to(x).emit("submitFinished",z)});v.on("submitFailed",function(){s.log("info","[submit failed] submit failed in report: "+u.getName()+" maybe some error has occurred.");u.setSyncState("wait");u.initSyncDoneCount();v.broadcast.to(x).emit("submitFailed")});v.on("note",function(z){if(u){if(l.getHeapProportion()>95){s.log("warning","heap memory proportion: "+l.getHeapProportion()+"%. becoming closer to the heap size limit.")}v.broadcast.to(x).emit("note",z)}});v.on("movePage",function(z){if(u){if(u.getOption("pageSync")){v.broadcast.to(x).emit("movePage",z.page);u.setHostPage(z.page)}else{if(z.isHost){if(u.isLock()){v.broadcast.to(x).emit("movePage",z.page)}u.setHostPage(z.page)}}}});v.on("isLock",function(z){if(!u.isLock()){z()}});v.on("error",function(z){throw new Error(z)});v.on("disconnect",function(A){s.log("debug","[client disconnect] client "+v.id+" disconnect. \r\n reason: "+A+" \r\n latest join: "+x);if(u&&a.getUserCount(x)===0){f.to("waiting").emit("removeReport",x);o.removeReport(x);s.log("info",'[destroy report] report "'+u.getName()+'" destroyed.')}else{if(u&&v.id===u.getHostId()){f.to(x).emit("hostDoesNotExist","share_stop_sharing");o.removeReport(x);return}if(u){var z=u.focusOutField(v.id);if(z){v.broadcast.to(x).emit("focusOut",z)}}f.to("waiting").emit("renewUserCount",{name:x,incCount:false})}});v.on("initFormField",function(z){v.broadcast.to(x).emit("initFormField",z)});v.on("reDrawPage",function(z){if(u){if(z.isHost){if(u.isLock()){v.broadcast.to(x).emit("reDrawPage")}}}});v.on("event",function(z){v.broadcast.to(x).emit("event",z)});v.on("requestFormData",function(){f.sockets.sockets[u.getHostId()].emit("getFormData",undefined,function(z){v.emit("responseFormData",w(u,z))})});v.on("drilldown",function(z){if(u){v.broadcast.to(x).emit("drilldown",z)}});v.on("startSync",function(){if(u&&u.getOption("useSync")){if(u.getSyncState()==="wait"){u.setSyncState("synchronization");f.to(x).emit("onOverlay")}u.incSyncCnt()}});v.on("endSync",function(){if(u&&u.getOption("useSync")){u.decSyncCnt();if(u.getSyncState()==="synchronization"&&u.getSyncDoneCount()===0){f.to(x).emit("offOverlay");u.setSyncState("wait")}}})})};module.exports.ConfigManager=function(){var b=require("fs");var d=require("deep-extend");var c;var f;var a={server:{port:52280,opts:{pingInterval:60000,pingTimeout:210000},log:{level:"4",dir:"./logs",timestamp:"YYYY-MM-DD HH:mm:ss",maxFiles:"100"}}};try{f=JSON.parse(b.readFileSync("./config.json","utf-8"));c=d(a,f)}catch(g){console.log("Exception: "+g.message);c=a}this.getConfig=function(k){var e=k.split(".");var h=c;for(var j=0,l=e.length;j<l;j++){h=h[e[j]];if(h===undefined){break}}return h}};