/*!
 * Copyright(c) 2014. M2SOFT Co., Ltd. All source codes cannot be copied without permission.
 * 
 * @version: 7.3.0.417
 * @bulid date: 2019/07/13 06:15
 */
var m2soft=m2soft||{};m2soft.ns=function(e){var d=e.split("."),c=m2soft;if(d[0]==="m2soft"){d=d.slice(1)}for(var b=0,a=d.length;b<a;b++){if(typeof c[d[b]]==="undefined"){c[d[b]]={}}c=c[d[b]]}return c};m2soft.ns("m2soft.crownix.FormField.Sign");m2soft.crownix.FormField.Sign=function(s,f){var j=m2soft.crownix.Util,i=m2soft.crownix.Resource;var l;var E=$("#"+s);var g=f&&f.dpi?f.dpi:96,t=E.width(),q=E.height()?E.height():E.width()*0.4,c=f.element,a=f.headInfo,b=f.field||{},o=f.formManager,u=parseInt(c.attr("sn"))||0,y=c.attr("bt")||"",D=c.attr("da"),z=0,r=[],F,x;var e=function(){F=(f&&f.width?f.width:t)*g/96,x=(f&&f.height?f.height:q)*g/96;q=E.height()?E.height():t*x/F;l=document.createElement("canvas");l.width=F;l.height=x;var G=l.getContext("2d");G.strokeStyle="#000000";G.lineWidth=(f.width/F+1)*Math.pow(g/96,2);G.lineJoin="round";G.lineCap="round"};var k=function(){var G=$("#"+s).prev(".crownix-quick-validity-message").text(i.get("unqualified_stroke"));if(!G){return}if(u==0||z==0||z>=u){b.value=l.toDataURL("image/png");b.lineInfo={lineArr:r,width:d.width(),height:d.height()};o.trigger("change",b.formId,b.id);o.modified();return G.css("display","none")}return G.css("display","block")};var n=function(O){var J=O,H=J.getContext("2d"),N=l.getContext("2d"),K=false,M,I,R=this,G=[];var Q={x:-1,y:-1,},P={x:-1,y:-1,},L={x:-1,y:-1};z=0;this.mousedown=function(S){G=[];S.preventDefault();if(b.editable=="0"||D==="1"){return}if(!y&&z==0){l.getContext("2d").clearRect(0,0,F,x);J.getContext("2d").clearRect(0,0,t,q)}I=$(O).offset().top;M=$(O).offset().left;Q.x=S.originalEvent.pageX-M;Q.y=S.originalEvent.pageY-I;G.push([Q.x,Q.y]);K=true;H.beginPath();N.beginPath();H.moveTo(Q.x,Q.y);N.moveTo(l.width*Q.x/H.canvas.width,l.height*Q.y/H.canvas.height);$("body").on("mousemove",R.mousemove);$("body").on("mouseup",R.mouseup)};this.mousemove=function(S){if(K){S.preventDefault();I=$(O).offset().top;M=$(O).offset().left;P.x=S.originalEvent.pageX-M;P.y=S.originalEvent.pageY-I;L.x=(Q.x+P.x)/2;L.y=(Q.y+P.y)/2;G.push([L.x,L.y]);if(Q!=P){H.quadraticCurveTo(Q.x,Q.y,L.x,L.y);N.quadraticCurveTo(l.width*Q.x/H.canvas.width,l.height*Q.y/H.canvas.height,l.width*L.x/H.canvas.width,l.height*L.y/H.canvas.height);H.stroke();N.stroke();Q.x=P.x;Q.y=P.y}}};this.mouseup=function(S){if(document.activeElement){document.activeElement.blur()}if(K){S.preventDefault();H.closePath();N.closePath();K=false;z++;r.push(G);$("body").off("mousemove",R.mousemove);$("body").off("mouseup",R.mouseup)}k()};this.on=function(){$(J).on("mousedown",this.mousedown)};this.off=function(){$(J).off("mousedown",this.mousedown)}};var p=function(M){var I=M,H=I.getContext("2d"),L=l.getContext("2d"),J=false,N=false,Q=this,G=[];var P={x:-1,y:-1,},O={x:-1,y:-1,},K={x:-1,y:-1};z=0;this.touchstart=function(U){G=[];U.preventDefault();N=true;setTimeout(function(){N=false},250);if(N){var T=U.target,S=document.createEvent("MouseEvents");S.initMouseEvent("click",true,true,U.view,1,T.screenX,T.screenY,T.clientX,T.clientY,U.ctrlKey,U.altKey,U.shiftKey,U.metaKey,0,null);S._constructed=true;T.dispatchEvent(S)}if(z==0&&b.value){C()}if(b.editable=="0"||D==="1"){return}if(!y&&z==0){L.clearRect(0,0,F,x);H.clearRect(0,0,t,q)}var R=U.touches[0];J=true;P.x=R.pageX-$(this).offset().left;P.y=R.pageY-$(this).offset().top;G.push([P.x,P.y]);H.beginPath();L.beginPath();H.moveTo(P.x,P.y);L.moveTo(l.width*P.x/H.canvas.width,l.height*P.y/H.canvas.height);I.addEventListener("touchmove",Q.touchmove,false);I.addEventListener("touchend",Q.touchend,false)};this.touchmove=function(S){S.preventDefault();if(J){N=false;var R=S.touches[0];O.x=R.pageX-$(this).offset().left;O.y=R.pageY-$(this).offset().top;K.x=(P.x+O.x)/2;K.y=(P.y+O.y)/2;G.push([K.x,K.y]);if(P!=O){H.quadraticCurveTo(P.x,P.y,K.x,K.y);L.quadraticCurveTo(l.width*P.x/H.canvas.width,l.height*P.y/H.canvas.height,l.width*K.x/H.canvas.width,l.height*K.y/H.canvas.height);H.stroke();L.stroke();P.x=O.x;P.y=O.y}}};this.touchend=function(R){if(document.activeElement){document.activeElement.blur()}R.preventDefault();if(J){H.closePath();L.closePath();J=false;z++;r.push(G);I.removeEventListener("touchmove",Q.touchmove,false);I.removeEventListener("touchend",Q.touchend,false)}k()};this.on=function(){I.addEventListener("touchstart",this.touchstart,false)};this.off=function(){I.removeEventListener("touchstart",this.touchstart,false)}};var C=function(){if(b.editable=="0"||D==="1"){return}l.getContext("2d").clearRect(0,0,F,x);d[0].getContext("2d").clearRect(0,0,t,q);w();B();k();r=[]};var B=function(){z=0};var w=function(){var I=new m2soft.crownix.Canvas(d[0]),N=a.fontList,J=a.textAttrList,L=y||c.attr("ph")||"",G=parseInt(c.attr("ha"))||0,M=parseInt(c.attr("va"))||0,H=J[c.attr("tid")]||{};if(G===1){G="center"}else{if(G===2){G="right"}else{G="left"}}var K={fontFamily:"Arial, sans-serif",fontSize:((c.attr("pt")?c.attr("pt")/10:H.pt/10)||10)+"pt",fillStyle:(c.attr("cl")?c.attr("cl"):H.cl)||"#000000",fontStyle:(c.attr("ci")?c.attr("ci")==="1":H.ci==="1")?"Italic":"",fontWeight:(c.attr("cb")?c.attr("cb")==="1":H.cb==="1")?"Bold":"",underLine:(c.attr("cu")?c.attr("cu")==="1":H.cu==="1")||!!c.attr("hl"),lineThrough:c.attr("cs")?c.attr("cs")==="1":H.cs==="1",shade:c.attr("cr")?c.attr("cr")==="1":H.cr==="1",textAlign:G==1?"center":(G==2?"right":"left"),adjustFontSize:true};K.textAlign=G;if(M==0){K.textBaseline="top"}else{if(M==1){K.textBaseline="middle"}else{K.textBaseline="bottom"}}I.drawText(L,0,0,d.width(),d.height(),K)};e();var d=$("<canvas>").css({position:"absolute",width:t,height:q,border:"1px solid"}).attr({width:t,height:q,formId:c.attr("fi"),name:c.attr("id"),id:"crownix_form_field_"+c.attr("fi")+"_"+c.attr("id")}).on("click",function(G){}).appendTo(E);var m=d[0].getContext("2d");m.strokeStyle="#000000";m.lineWidth=(t/F)*(g/96)+1;m.lineJoin="round";m.lineCap="round";var v=$("<div>").css({position:"relative","float":"right","font-weight":"bold",padding:"5px",cursor:"pointer",width:"25px",height:"25px",}).on("click",C).appendTo(E);$(m2soft.crownix.resource.Icon.RESET_ICON).appendTo(v);w();var h=new n(d[0]);h.on();if(j.hasTouch()){var A=new p(d[0]);A.on()}this.dpiWidth=F;this.dpiHeight=x;this.getValue=function(){return l.toDataURL("image/png")};this.getLineInfo=function(){return r.length};this.resizeCanvas=function(L){var Q=L.isResize?t:L.lineInfo.width,G=L.isResize?q:L.lineInfo.height,O,N,M;t=L.width||d.width();q=L.height||d.height();N=q/G;O=t/Q;if(L.lineInfo&&L.lineInfo.lineArr){r=L.lineInfo.lineArr}if(L.width&&L.height){d.attr({width:t,height:q}).css({width:t,height:q});b.lineInfo.width=L.width;b.lineInfo.height=L.height}m=d[0].getContext("2d");m.strokeStyle="#000000";m.lineWidth=(t/F)*(g/96)+1;m.lineJoin="round";m.lineCap="round";M=l.getContext("2d");z=r.length;m.clearRect(0,0,d.width(),d.height());if(z==0||y){w()}for(var K=0;K<r.length;K++){if(r[K].length!=0){for(var J=0;J<r[K].length;J++){for(var I=0;I<r[K][J].length-1;I++){r[K][J][I]=r[K][J][I]*O;r[K][J][I+1]=r[K][J][I+1]*N}}m.beginPath();M.beginPath();for(var J=0;J<r[K].length;J++){var P=r[K][J];for(var I=0;I<r[K][J].length-1;I++){m.moveTo(P[I],P[I+1]);M.moveTo(l.width*P[I]/m.canvas.width,l.height*P[I+1]/m.canvas.height)}if(J!=r[K].length-1){var H=r[K][J+1];for(var I=0;I<r[K][J].length-1;I++){m.lineTo(H[I],H[I+1]);M.lineTo(l.width*H[I]/m.canvas.width,l.height*H[I+1]/m.canvas.height)}}m.stroke();M.stroke()}m.closePath();M.closePath()}}}};