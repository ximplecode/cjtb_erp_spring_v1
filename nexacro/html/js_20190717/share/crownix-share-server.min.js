exports.start=function(){process.on("uncaughtException",function(p){if(o){o.log("crit","[uncaughtException] "+p.stack)}else{console.log("[uncaughtException] "+p.stack)}});var j=require("fs");var c=JSON.parse(j.readFileSync("./config.json","utf-8"));var b=j.readdirSync("./").indexOf("crownix-share-logger.js")>=0?require("./crownix-share-logger.js"):require("./crownix-share-logger.min.js");var i=require("v8");var e=require("os");var o=new b(c.server.log);var l=require("socket.io").listen(c.server.port||52280,{pingInterval:c.server.opts.pingInterval||60000,pingTimeout:c.server.opts.pingTimeout||210000});var d=Object.prototype.hasOwnProperty;function f(q){if(q==null){return true}if(q.length>0){return false}if(q.length===0){return true}if(typeof q!=="object"){return true}for(var p in q){if(d.call(q,p)){return false}}return true}console.log("Server Running at http://ServerURL:"+c.server.port);o.log("info","[Server start] module load complete. Share Server start. \r\n Node.js Version:"+process.version+" \r\n OS type: "+e.type());var k=function(F,t){var s=function(M){var J={},L=JSON.parse(M);for(var H in L){J[H]=[];L[H]=L[H].replace("<note>","");L[H]=L[H].replace("</note>","");var N=0,I=-1;while((I=L[H].indexOf("</element>",N))>=0){var K=L[H].substring(N,I+10);N=I+10;J[H].push({pageNo:parseInt(H),type:K.indexOf('type="scribble"')>=0?"scribble":"text",xml:"<note>"+K+"</note>"})}}return J};var G=F.name,q=F.password,E=F.mrd,u=F.curPage,z=(F.formData&&F.formData.formData)||{},D=(F.formData&&F.formData.removedPage)||{},B=(F.formData&&F.formData.drilldownInfo)||{},p=(F.noteData&&s(F.noteData))||{},C=[],t=t,A=true,r=0,y="wait";this.reopenReport=function(H){E=H.mrd,u=H.curPage,z=(H.formData&&H.formData.formData)||{},D=(H.formData&&H.formData.removedPage)||{},B=(H.formData&&H.formData.drilldownInfo)||{},p=(H.noteData&&s(H.noteData))||{},C=[],r=0,y="wait"};this.focusOnField=function(K,M){if(f(z)){return}for(var I=0;I<z.formdata.form.length;I++){var J=z.formdata.form[I];if(J.id==K.formId){for(var H=0;H<J.fields.field.length;H++){var L=J.fields.field[H];if(L.id==K.fieldId){L.owner=M;break}}break}}};this.focusOutField=function(L){if(f(z)){return}for(var I=0;I<z.formdata.form.length;I++){var J=z.formdata.form[I];for(var H=0;H<J.fields.field.length;H++){var K=J.fields.field[H];if(K.owner==L){K.owner=undefined;return{formId:J.id,fieldId:K.id}}}}};this.getFormData=function(){return z};this.getNoteData=function(){return p};var v=function(I){if(typeof I!=="string"||I.length==0){return}var H=I.substr(I.indexOf('path="')+6);return H.substr(0,H.indexOf('"'))};this.drawNote=function(L){var K=L.pageNo;if(!p[K]||L.type=="clearElement"){p[K]=[]}if(L.type=="scribble"){p[K].push(L)}else{if(L.type=="erase"){for(var I=0;I<p[K].length;I++){var H=p[K][I].xml,M=L.xml;if((L.elementType=="text"&&H==M)||(L.elementType!="text"&&v(H)==v(M))){p[K].splice(I,1);break}}}else{if(L.type=="text"){if(L.oldXml){for(var I=0;I<p[K].length;I++){if(p[K][I].type=="text"){var H=p[K][I].xml,J=L.oldXml;if(H===J){p[K][I]=L;break}}}}else{p[K].push(L)}}}}if(a.getHeapProportion()>95){o.log("warning","heap memory proportion: "+a.getHeapProportion()+"%. becoming closer to the heap size limit.")}return p[K]};this.changeField=function(K,N){if(f(z)){return}try{for(var I=0;I<z.formdata.form.length;I++){var J=z.formdata.form[I];if(J.id==K.formId){for(var H=0;H<J.fields.field.length;H++){var M=J.fields.field[H];if(M.id==K.fieldId){if(K.name=="editable"||K.name=="required"){M[K.name]=K.value?"1":"0"}else{if(K.name=="label"){M.label={__cdata:K.value}}else{if(M.type==="co"){M.selectedIndex=K.value}else{if(M.type==="rg"){M.selectedId=K.value}else{if(M.type==="rb"&&K.name=="selected"){this.changeField({formId:K.formId,fieldId:K.groupId,value:K.fieldId})}else{M.value={__cdata:K.value}}}}}}if(M.type==="fl"){M.fileHolder=N}break}}break}}}catch(L){o.log("error","[changeField error] "+L)}};this.isNotFileHolder=function(H,N){var M;if(H){M=H.indexOf(",")>=0?H.split(","):H}for(var J=0;J<z.formdata.form.length;J++){var K=z.formdata.form[J];if(M){if(typeof M==="string"&&M!==K.id){continue}else{if(typeof M==="object"&&M.indexOf(K.id)<0){continue}}}for(var I=0;I<K.fields.field.length;I++){var L=K.fields.field[I];if(L.type==="fl"&&L.value.__cdata&&(typeof L.fileHolder==="undefined"||L.fileHolder!==N)){return true}}}return false};var x=function(J){for(var H=0;H<z.formdata.form.length;H++){var I=z.formdata.form[H];if(I.id==J){return I}}};var w=function(M,H){for(var J=0;J<z.formdata.form.length;J++){var K=z.formdata.form[J];if(K.id==M){for(var I=0;I<K.fields.field.length;I++){var L=K.fields.field[I];if(L.id==H){return L}}}}};this.setFormData=function(L){if(!L||f(z)){return}for(var J=0;J<L.formdata.form.length;J++){var K=L.formdata.form[J],H=x(K.id);if(!H){H={id:formId,fields:{field:[]}};z.formdata.form.push(H)}for(var I=0;I<K.fields.field.length;I++){var M=K.fields.field[I];if(!w(H.id,M.id)){H.fields.field.push(M)}}}};this.setDrilldownInfo=function(H){if(!H){return}B=H};this.changeLock=function(H){A=H};this.changeLock=function(H){A=H};this.isLock=function(){return A};this.getName=function(){return G};this.getPassword=function(){return q};this.getMrd=function(){return E};this.getCurPage=function(){return u};this.setHostId=function(H){t=H};this.getHostId=function(){return t};this.getFormData=function(){return z};this.getRemovedPage=function(){return D};this.getDrilldownInfo=function(){return B};this.syncDone=function(){++r};this.initSyncDoneCount=function(){r=0};this.getSyncDoneCount=function(){return r};this.setSyncState=function(H){y=H};this.getSyncState=function(){return y};this.setHostPage=function(H){u=H}};var h=function(){var p=[];this.createReport=function(r,s){if(!this.getReport(r.name)){var q=new k(r,s);p.push(q);l.to("waiting").emit("newReport",{name:r.name,isPublic:!r.password});if(a.getHeapProportion()>95){o.log("warning","heap memory proportion: "+a.getHeapProportion()+"%. becoming closer to the heap size limit.")}return q}};this.joinReport=function(r,s){var q=this.getReport(s.name);if(q){if(q.getPassword()&&q.getPassword()!=s.password){return"share_wrong_password"}r.emit("openFile",{mrd:q.getMrd(),pageNo:q.getCurPage(),formData:{formData:q.getFormData(),removedPage:q.getRemovedPage(),drilldownInfo:q.getDrilldownInfo()},noteData:q.getNoteData(),isLock:q.isLock()});if(!s.reconnect){l.to("waiting").emit("renewUserCount",{name:s.name,incCount:true})}return q}else{return"share_undefined_room"}};this.getReport=function(r){var q;p.some(function(s){if(r==s.getName()){q=s;return true}});return q};this.getReports=function(){return p};this.getReportList=function(){var q=p.sort(function(t,s){if(t.getName()<s.getName()){return -1}if(t.getName()>s.getName()){return 1}return 0});var r=[];q.forEach(function(s){r.push({name:s.getName(),isPublic:!s.getPassword(),userCount:m(s.getName())})});return r};this.removeReport=function(q){p.some(function(r){if(r.getName()===q){p.splice(p.indexOf(r),1);return true}})};this.destroyReport=function(q){l.to(q).emit("hostDoesNotExist","share_stop_sharing");this.removeReport(q)}};var n=function(){this.getHeapUsage=function(){var p=i.getHeapStatistics();return((p.used_heap_size/p.total_heap_size)*100).toFixed(2)};this.getHeapProportion=function(){var p=i.getHeapStatistics();return((p.total_heap_size/p.heap_size_limit)*100).toFixed(2)}};var m=function(p){var q=l.sockets.adapter.rooms[p];return q?q.length:0};var g=new h();var a=new n();l.sockets.on("connection",function(r){o.log("debug","[client connect] new client "+r.id+" connect.");var q,s="waiting";function p(u){r.leave(s);r.join(u);s=u}function t(){r.leave(s);r.join("waiting");s="waiting"}r.join(s);r.emit("reportList",g.getReportList());r.on("createReport",function(w,u){var v=g.createReport(w,r.id);if(v){q=v;p(w.name);r.emit("startSharing","host");u({name:w.name,password:w.password});o.log("info","[create report] report created. \r\n name: "+w.name+" \r\n host: "+r.id+" \r\n type: "+(w.password?"private":"public"))}else{r.emit("shareError",{message:"share_duplicated_name"})}});r.on("reopenReport",function(u){q.reopenReport(u);r.broadcast.to(s).emit("openFile",{mrd:q.getMrd(),pageNo:q.getCurPage(),formData:{formData:q.getFormData(),removedPage:q.getRemovedPage(),drilldownInfo:q.getDrilldownInfo()},noteData:q.getNoteData(),isLock:q.isLock()});o.log("info","[reopen report] report reopened. \r\n report: "+q.getName()+" \r\n opener: "+r.id)});r.on("joinReport",function(x,u){var v=g.joinReport(r,x);if(v&&typeof v==="object"){q=v;p(x.name);var w=x.isHost;if(w){q.setHostId(r.id)}r.emit("startSharing",w?"host":"client");u({name:x.name,password:x.password});o.log("info","[join report] client "+r.id+" join report: "+x.name)}else{if(v&&typeof v==="string"){r.emit("shareError",{message:v})}}});r.on("formField",function(u){if(q){q.changeField(u,r.id);r.broadcast.to(s).emit("formField",u)}});r.on("drilldownInfo",function(u){if(q){q.setDrilldownInfo(u.drilldownInfo);q.setFormData(u.formData)}});r.on("focusOn",function(v){if(q){var u=q.focusOutField(r.id);if(u){r.broadcast.to(s).emit("focusOut",u)}q.focusOnField(v,r.id);v.isLock=q.isLock();r.broadcast.to(s).emit("focusOn",v)}});r.on("focusOut",function(){if(q){var u=q.focusOutField(r.id);if(u){r.broadcast.to(s).emit("focusOut",u)}}});r.on("lockFields",function(){if(!q.isLock()){q.changeLock(true);r.broadcast.to(s).emit("lockFields");r.broadcast.to(s).emit("movePage",q.getCurPage())}});r.on("unlockFields",function(){if(q.isLock()){q.changeLock(false);r.broadcast.to(s).emit("unlockFields")}});r.on("submitRequest",function(y,v){o.log("info","[submit request] client "+r.id+" request for submit. \r\n report: "+q.getName());var x=q.getSyncState();if(x==="synchronization"||x==="done"){return}q.setSyncState("synchronization");if(q.isNotFileHolder(y,r.id)){v("invalid_submit_request");q.setSyncState("reset");return}var u=Object.keys(l.sockets.adapter.rooms[s].sockets);if(u.length===1){v("done");q.setSyncState("done");return}for(var w=0;w<u.length;w++){(function(){var z=w;l.sockets.connected[u[z]].once("syncDone",function(){q.syncDone();o.log("debug","[sync done] sync done event emitted from client "+l.sockets.connected[u[z]].id);if(q.getSyncDoneCount()===(m(s)-1)){v("done");q.setSyncState("done");o.log("debug","[all client sync done] all client sync done event emitted in report "+s)}})})()}r.broadcast.to(s).emit("syncFormData",{formData:q.getFormData(),removedPage:q.getRemovedPage(),drilldownInfo:q.getDrilldownInfo()});o.log("debug","[sync form data] form data broadcast for field synchronization. in report "+s)});r.on("submitFinished",function(u){o.log("info","[submit finished] submit finished. \r\n report: "+q.getName());r.broadcast.to(s).emit("submitFinished",u)});r.on("submitFailed",function(){o.log("info","[submit failed] submit failed in report: "+q.getName()+" maybe some error has occurred.");q.setSyncState("wait");q.initSyncDoneCount();r.broadcast.to(s).emit("submitFailed")});r.on("note",function(u){if(q){var v=q.drawNote(u);r.broadcast.to(s).emit("note",u)}});r.on("script",function(u){if(q){if(u.name!=="expandDrilldown"&&u.name!=="collapseDrilldown"){q.changeField(u)}r.broadcast.to(s).emit("script",u)}});r.on("movePage",function(u){if(q){if(u.isHost){if(q.isLock()){r.broadcast.to(s).emit("movePage",u.page)}q.setHostPage(u.page)}}});r.on("isLock",function(u){if(!q.isLock()){u()}});r.on("error",function(u){throw new Error(u)});r.on("disconnect",function(v){o.log("debug","[client disconnect] client "+r.id+" disconnect. \r\n reason: "+v+" \r\n latest join: "+s);if(q&&m(s)===0){l.to("waiting").emit("removeReport",s);g.removeReport(s);o.log("info",'[destroy report] report "'+q.getName()+'" destroyed.')}else{if(q&&r.id===q.getHostId()){g.destroyReport(s);return}if(q){var u=q.focusOutField(r.id);if(u){r.broadcast.to(s).emit("focusOut",u)}}l.to("waiting").emit("renewUserCount",{name:s,incCount:false})}})})};